

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="本篇文章主要对hashcode为什么使用31作为乘数进行分析。">
<meta property="og:type" content="article">
<meta property="og:title" content="HashCode为什么使用31作为乘数">
<meta property="og:url" content="http://caohuisheng.github.io/2024/09/01/HashMap%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="本篇文章主要对hashcode为什么使用31作为乘数进行分析。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://gitee.com/caohuisheng/imgbed/raw/master/img/202409011614425.png">
<meta property="og:image" content="https://gitee.com/caohuisheng/imgbed/raw/master/img/202409011624789.png">
<meta property="og:image" content="https://gitee.com/caohuisheng/imgbed/raw/master/img/202409011625143.png">
<meta property="article:published_time" content="2024-09-01T07:24:47.000Z">
<meta property="article:modified_time" content="2024-09-01T08:36:57.233Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://gitee.com/caohuisheng/imgbed/raw/master/img/202409011614425.png">
  
  
  
  <title>HashCode为什么使用31作为乘数 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"caohuisheng.github.io","root":"/","version":"1.9.7","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":false};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>Links</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">HashCode为什么使用31作为乘数</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-09-01 15:24" pubdate>
          September 1, 2024 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          1.6k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          14 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">HashCode为什么使用31作为乘数</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>HashMap是用来存储键值对的数据结构，是用哈希表来实现的，可以实现O(1)时间复杂度的插入和查找。哈希表的基本原理即通过计算key的哈希值将元素插入到指定位置，因此在分析HashMap源码之前需要先分析一下哈希值的计算过程。</p>
<p>查看String类的源码可以发现，它重写了hashcode方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> hash;<br>    <span class="hljs-keyword">if</span> (h == <span class="hljs-number">0</span> &amp;&amp; value.length &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-type">char</span> val[] = value;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; value.length; i++) &#123;<br>            h = <span class="hljs-number">31</span> * h + val[i];<br>        &#125;<br>        hash = h;<br>    &#125;<br>    <span class="hljs-keyword">return</span> h;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到String类的hashcode方法遍历字符串的每个字符做与31做乘积运算，公式如下：$s[0]^{n-1}+s[1]^{n-2}+…s[n-1]$，那这里为什么要使用31作为乘数呢？</p>
<p>stackoverflow中有一篇讨论文章<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/299304/why-does-javas-hashcode-in-string-use-31-as-a-multiplier">Why does Java’s hashCode() in String use 31 as a multiplier? - Stack Overflow</a>，其中有一个高赞回答：</p>
<p>Goodrich and Tamassia computed from over 50,000 English words (formed as the union of the word lists provided in two variants of Unix) that using the constants 31, 33, 37, 39, and 41 will produce fewer than 7 collisions in each case. This may be the reason that so many Java implementations choose such constants.</p>
<p>即计算超过50000个单词的hashcode，分别使用31，33，37，39作为乘数，计算碰撞结果。下面我们就来做这个实验，观察不同乘数的碰撞结果。</p>
<h2 id="2-hashcode碰撞概率统计"><a href="#2-hashcode碰撞概率统计" class="headerlink" title="2. hashcode碰撞概率统计"></a>2. hashcode碰撞概率统计</h2><h3 id="2-1-计算hashcode碰撞概率"><a href="#2-1-计算hashcode碰撞概率" class="headerlink" title="2.1 计算hashcode碰撞概率"></a>2.1 计算hashcode碰撞概率</h3><p>首先准备10万个单词：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-number">1</span>	a	<span class="hljs-string">&quot;n.(A)As 或 A&#x27;s  安(ampere(a) art.一;n.字母A /[军] Analog.Digital,模拟/数字 /(=account of) 帐上&quot;</span><br><span class="hljs-number">2</span>	aaal	American Academy of Arts <span class="hljs-keyword">and</span> Letters 美国艺术和文学学会<br><span class="hljs-number">3</span>	aachen	 亚琛[德意志联邦共和国西部城市]<br><span class="hljs-number">4</span>	aacs	Airways <span class="hljs-keyword">and</span> Air Communications Service (美国)航路与航空通讯联络处<br><span class="hljs-symbol">...</span><br></code></pre></td></tr></table></figure>

<p>读取单词：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//读取每一个单词，并将单词保存在一个Set集合中。</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Set&lt;String&gt; <span class="hljs-title function_">readWordList</span><span class="hljs-params">(String url)</span> &#123;<br>    Set&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">isr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(url), StandardCharsets.UTF_8);<br>        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(isr);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>            String[] ss = line.split(<span class="hljs-string">&quot;\t&quot;</span>);<br>            list.add(ss[<span class="hljs-number">1</span>]);<br>        &#125;<br>        br.close();<br>        isr.close();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception ignore) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> list;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>hashcode函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Integer <span class="hljs-title function_">hashCode</span><span class="hljs-params">(String str, Integer multiplier)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; str.length(); i++) &#123;<br>        hash = multiplier * hash + str.charAt(i);<br>    &#125;<br>    <span class="hljs-keyword">return</span> hash;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>计算hash碰撞概率：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//计算hash碰撞概率</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RateInfo <span class="hljs-title function_">hashCollisionRate</span><span class="hljs-params">(Integer multiplier, List&lt;Integer&gt; hashCodeList)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">maxHash</span> <span class="hljs-operator">=</span> hashCodeList.stream().max(Integer::compareTo).get();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">minHash</span> <span class="hljs-operator">=</span> hashCodeList.stream().min(Integer::compareTo).get();<br>	<span class="hljs-comment">//将hashcode去重，计算重复元素的比例</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">collisionCount</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (hashCodeList.size() - hashCodeList.stream().distinct().count());<br>    <span class="hljs-type">double</span> <span class="hljs-variable">collisionRate</span> <span class="hljs-operator">=</span> (collisionCount * <span class="hljs-number">1.0</span>) / hashCodeList.size();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RateInfo</span>(maxHash, minHash, multiplier, collisionCount, collisionRate);<br>&#125;<br><br><span class="hljs-comment">//计算不同乘数的hash碰撞概率</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;RateInfo&gt; <span class="hljs-title function_">collisionRateList</span><span class="hljs-params">(Set&lt;String&gt; strList, Integer... multipliers)</span> &#123;<br>    List&lt;RateInfo&gt; rateInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (Integer multiplier : multipliers) &#123;<br>        List&lt;Integer&gt; hashCodeList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (String str : strList) &#123;<br>            <span class="hljs-type">Integer</span> <span class="hljs-variable">hashCode</span> <span class="hljs-operator">=</span> hashCode(str, multiplier);<br>            hashCodeList.add(hashCode);<br>        &#125;<br>        rateInfoList.add(hashCollisionRate(multiplier, hashCodeList));<br>    &#125;<br>    <span class="hljs-keyword">return</span> rateInfoList;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里RateInfo为自定义类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RateInfo</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> maxHash;            <span class="hljs-comment">// 最大Hash</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> minHash;            <span class="hljs-comment">// 最小Hash</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> multiplier;         <span class="hljs-comment">// hash计算乘机因子</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> collisionCount;     <span class="hljs-comment">// 碰撞数</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> collisionRate;   <span class="hljs-comment">// 碰撞比率</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-2-单元测试"><a href="#2-2-单元测试" class="headerlink" title="2.2 单元测试"></a>2.2 单元测试</h3><p>编写单元测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Set&lt;String&gt; words;<br><br><span class="hljs-meta">@Before</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-string">&quot;abc&quot;</span>.hashCode();<br>    <span class="hljs-comment">// 读取文件，103976个英语单词库.txt</span><br>    words = FileUtil.readWordList(<span class="hljs-string">&quot;103976个英语单词库.txt&quot;</span>);<br>&#125;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test_collisionRate</span><span class="hljs-params">()</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;单词数量：&quot;</span> + words.size());<br>    List&lt;RateInfo&gt; rateInfoList = HashCode.collisionRateList(words, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">17</span>, <span class="hljs-number">31</span>, <span class="hljs-number">32</span>, <span class="hljs-number">33</span>, <span class="hljs-number">39</span>, <span class="hljs-number">41</span>, <span class="hljs-number">199</span>);<br>    <span class="hljs-keyword">for</span> (RateInfo rate : rateInfoList) &#123;<br>        System.out.println(String.format(<span class="hljs-string">&quot;乘数 = %4d, 最小Hash = %11d, 最大Hash = %10d, 碰撞数量 =%6d, 碰撞概率 = %.4f%%&quot;</span>, rate.getMultiplier(), rate.getMinHash(), rate.getMaxHash(), rate.getCollisionCount(), rate.getCollisionRate() * <span class="hljs-number">100</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">单词数量：<span class="hljs-number">103976</span><br>乘数 =    <span class="hljs-number">2</span>, 最小Hash =          <span class="hljs-number">97</span>, 最大Hash = <span class="hljs-number">1842581979</span>, 碰撞数量 = <span class="hljs-number">60382</span>, 碰撞概率 = <span class="hljs-number">58.0730</span>%<br>乘数 =    <span class="hljs-number">3</span>, 最小Hash = -<span class="hljs-number">2147308825</span>, 最大Hash = <span class="hljs-number">2146995420</span>, 碰撞数量 = <span class="hljs-number">24300</span>, 碰撞概率 = <span class="hljs-number">23.3708</span>%<br>乘数 =    <span class="hljs-number">5</span>, 最小Hash = -<span class="hljs-number">2147091606</span>, 最大Hash = <span class="hljs-number">2147227581</span>, 碰撞数量 =  <span class="hljs-number">7994</span>, 碰撞概率 = <span class="hljs-number">7.6883</span>%<br>乘数 =    <span class="hljs-number">7</span>, 最小Hash = -<span class="hljs-number">2147431389</span>, 最大Hash = <span class="hljs-number">2147226363</span>, 碰撞数量 =  <span class="hljs-number">3826</span>, 碰撞概率 = <span class="hljs-number">3.6797</span>%<br>乘数 =   <span class="hljs-number">17</span>, 最小Hash = -<span class="hljs-number">2147238638</span>, 最大Hash = <span class="hljs-number">2147101452</span>, 碰撞数量 =   <span class="hljs-number">576</span>, 碰撞概率 = <span class="hljs-number">0.5540</span>%<br>乘数 =   <span class="hljs-number">31</span>, 最小Hash = -<span class="hljs-number">2147461248</span>, 最大Hash = <span class="hljs-number">2147444544</span>, 碰撞数量 =     <span class="hljs-number">2</span>, 碰撞概率 = <span class="hljs-number">0.0019</span>%<br>乘数 =   <span class="hljs-number">32</span>, 最小Hash = -<span class="hljs-number">2007883634</span>, 最大Hash = <span class="hljs-number">2074238226</span>, 碰撞数量 = <span class="hljs-number">34947</span>, 碰撞概率 = <span class="hljs-number">33.6106</span>%<br>乘数 =   <span class="hljs-number">33</span>, 最小Hash = -<span class="hljs-number">2147469046</span>, 最大Hash = <span class="hljs-number">2147378587</span>, 碰撞数量 =     <span class="hljs-number">1</span>, 碰撞概率 = <span class="hljs-number">0.0010</span>%<br>乘数 =   <span class="hljs-number">39</span>, 最小Hash = -<span class="hljs-number">2147463635</span>, 最大Hash = <span class="hljs-number">2147443239</span>, 碰撞数量 =     <span class="hljs-number">0</span>, 碰撞概率 = <span class="hljs-number">0.0000</span>%<br>乘数 =   <span class="hljs-number">41</span>, 最小Hash = -<span class="hljs-number">2147423916</span>, 最大Hash = <span class="hljs-number">2147441721</span>, 碰撞数量 =     <span class="hljs-number">1</span>, 碰撞概率 = <span class="hljs-number">0.0010</span>%<br>乘数 =  <span class="hljs-number">199</span>, 最小Hash = -<span class="hljs-number">2147459902</span>, 最大Hash = <span class="hljs-number">2147480320</span>, 碰撞数量 =     <span class="hljs-number">0</span>, 碰撞概率 = <span class="hljs-number">0.0000</span>%<br></code></pre></td></tr></table></figure>

<p>根据不同乘数的碰撞概率绘制图像如下：</p>
<img src="https://gitee.com/caohuisheng/imgbed/raw/master/img/202409011614425.png" srcset="/img/loading.gif" lazyload alt="image-20240901161440223" style="zoom: 67%;" />

<p>根据结果可以看出，乘数为2、3、5、7、17、32时，碰撞概率都较大，乘数为31、33、39、41、199时，碰撞概率较小，但是乘数较大时，hashcode也会溢出，导致丢失信息。</p>
<h2 id="3-hashcode散列分布"><a href="#3-hashcode散列分布" class="headerlink" title="3. hashcode散列分布"></a>3. hashcode散列分布</h2><p>除了计算不同乘数下的hashcode碰撞概率，还需要计算hashcode的分布，只有当hashcode分布均匀时，才能减少碰撞。</p>
<p>为了计算hashcode的散列分布，可以将int的取值范围2^64分成64份，统计每个范围的hashcode数量即可。</p>
<h3 id="3-1-哈希值分段存放"><a href="#3-1-哈希值分段存放" class="headerlink" title="3.1 哈希值分段存放"></a>3.1 哈希值分段存放</h3><p>计算每个区间的hashcode数量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;Integer, Integer&gt; <span class="hljs-title function_">hashArea</span><span class="hljs-params">(List&lt;Integer&gt; hashCodeList)</span> &#123;<br>    Map&lt;Integer, Integer&gt; statistics = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x80000000</span>; i &lt;= <span class="hljs-number">0x7fffffff</span>; i += <span class="hljs-number">67108864</span>) &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">min</span> <span class="hljs-operator">=</span> i;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">max</span> <span class="hljs-operator">=</span> min + <span class="hljs-number">67108864</span>;<br>        <span class="hljs-comment">// 筛选出每个区间的哈希值数量</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) hashCodeList.parallelStream().filter(x -&gt; x &gt;= min &amp;&amp; x &lt; max).count();<br>        statistics.put(start++, num);<br>    &#125;<br>    <span class="hljs-keyword">return</span> statistics;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;Integer, Integer&gt; <span class="hljs-title function_">hashArea</span><span class="hljs-params">(Set&lt;String&gt; strList, Integer multiplier)</span>&#123;<br>    List&lt;Integer&gt; hashCodeList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (String str : strList) &#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">hashCode</span> <span class="hljs-operator">=</span> hashCode(str, multiplier);<br>        hashCodeList.add(hashCode);<br>    &#125;<br>    <span class="hljs-keyword">return</span> hashArea(hashCodeList);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-2-单元测试"><a href="#3-2-单元测试" class="headerlink" title="3.2 单元测试"></a>3.2 单元测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test_hashArea</span><span class="hljs-params">()</span> &#123;<br>    System.out.println(HashCode.hashArea(words, <span class="hljs-number">2</span>).values());<br>    System.out.println(HashCode.hashArea(words, <span class="hljs-number">7</span>).values());<br>    System.out.println(HashCode.hashArea(words, <span class="hljs-number">31</span>).values());<br>    System.out.println(HashCode.hashArea(words, <span class="hljs-number">32</span>).values());<br>    System.out.println(HashCode.hashArea(words, <span class="hljs-number">199</span>).values());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>上面计算了不同乘数在每个区间的hashcode数量，绘制图像如下：</p>
<p><img src="https://gitee.com/caohuisheng/imgbed/raw/master/img/202409011624789.png" srcset="/img/loading.gif" lazyload alt="image-20240901162455507"></p>
<p><img src="https://gitee.com/caohuisheng/imgbed/raw/master/img/202409011625143.png" srcset="/img/loading.gif" lazyload alt="image-20240901162518911"></p>
<p>可以看到乘数为2、7、32时，hashcode分布都不是很均匀，乘数为31、199时分布较均匀，只有部分区间包含较多元素，但是使用199作为乘数会导致数据溢出，丢失信息，不能选择，因此选择31作为乘数是比较适合的。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>本文主要分析了String类中的hashcode为什么使用31作为乘数，通过使用不同的乘数计算hashcode，统计hashcode的碰撞概率和散列分布情况，得出结论：使用31作为乘数时，hashcode的碰撞概率较小，分布区间较均匀，并且hashcode的数据范围较小，不易产生溢出和数据丢失问题。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" class="category-chain-item">数据结构与算法</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Java/" class="print-no-link">#Java</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>HashCode为什么使用31作为乘数</div>
      <div>http://caohuisheng.github.io/2024/09/01/HashMap源码分析/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>September 1, 2024</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/05/22/ArrayList%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="ArrayList源码分析">
                        <span class="hidden-mobile">ArrayList源码分析</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
